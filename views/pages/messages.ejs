<% include ../partials/head %>

<main class="slds-card">
	<div id="loaderBlock"><h2 class="slds-text-heading_medium slds-p-top_medium slds-p-bottom_medium sfdx-wrap"><img src="../dist/assets/images/loader.gif" style="width:27px;" /> Deployment ID <strong id="deployId"><%= deployId %></strong></h2></div>

	<div id="loginBlock" style="display: none;">
		<div class="slds-notify_container slds-is-relative slds-m-bottom_large sfdx-wrap">


			<div class="slds-notify slds-notify_toast slds-theme_success" role="alert">
				<span class="slds-assistive-text">warning</span>

				<div class="slds-notify__content">
					<h2 class="slds-text-heading_small ">Nice! Your app has been deployed! You can access it at: <strong><a id="loginUrl" target="_blank" href=""></a></strong></h2>
				</div>
			</div>

			<p class="slds-m-around_large"><strong>Note:</strong> It can take up to 5 minutes for the my domain DNS to propogate. If the scratch org doesn't load, refresh it in a few minutes.</p>

		</div>
	</div>

	<div id="status" class="slds-m-bottom_small sfdx-output"></div>
	<script>
		const HOST = location.href.replace(/^http/, 'ws');
		let msgCounter = 0;
		console.log(HOST);

		const deployIdInput = document.getElementById('deployId');
		console.log(deployIdInput);

		const deployId = deployIdInput.innerText;
		console.log(deployId);

		const ws = new WebSocket(HOST);
		let pinger;

		// const deployId = deployIdInput.value;

		// console.log(deployId);

		ws.onmessage = function (event) {
			msgCounter++;
			// console.log(event);
			try {
				let parsedData = JSON.parse(event.data);
				if (parsedData.deployId === deployId) {
					console.log('mine');
					console.log(parsedData);
					displayContent(parsedData.content);
				} else {
					console.log('not mine');
					console.log(parsedData);
				}
			} catch (err) {
				console.log('unparseable message (not JSON)');
				console.log(event.data);
			}

		};

		ws.onopen = function () {
			console.log('WS is open!');
			pinger = setInterval(function(){
				ws.send('ping');
			}, 5000);
		};

		ws.onclose = function(){
			console.log('WS is closing');
		}

		displayContent = function(content){
			// the login url
			if (content.result.url.includes('secur/frontdoor')){
				console.log('This is the login url');
				var link = document.getElementById("loginUrl");
				link.href = content.result.url;
				link.innerHTML = content.result.url;
				document.getElementById("loginBlock").setAttribute("style", "display : block");
			} else {
				// everything unspecified
				var para = document.createElement("p");
				var node = document.createTextNode(content);
				para.appendChild(node);

				var element = document.getElementById("status");
				element.appendChild(para);
			}

		}

	</script>

</main>
<% include ../partials/footer %>